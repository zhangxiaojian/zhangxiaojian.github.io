<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="life test">
    <meta name="keywords"  content="mysql">
    <meta name="theme-color" content="#000000">

    <title>MySQL 权限浅析 - 张小贱的博客 | Zhangxiaojian Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/computer%20science/database/2018/02/06/performance-schema-acl/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">张小贱</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    
                    <li>
                        <a href="/tags/">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/home-bg-o.jpg" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/home-bg-o.jpg')
    }

    
</style>
<header class="intro-header" >
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                    </div>
                    <h1>MySQL 权限浅析</h1>
                    
                    
                    <h2 class="subheading"></h2>
                    
                    <span class="meta">Posted by zhangxiaojian on February 6, 2018</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<h2 id="两个权限问题">两个权限问题</h2>

<h3 id="初始化的-test-database-的权限">初始化的 Test Database 的权限</h3>
<p>如果要使用 MySQL 数据库，要由高权限账号创建一个用户，再赋予这个用户相应的权限，用户就可以连接到数据库进行权限范围内的操作。参考官方文档 <a href="https://dev.mysql.com/doc/refman/5.7/en/create-user.html">Create user</a> , <a href="https://dev.mysql.com/doc/refman/5.7/en/grant.html">Grant privilegs</a>。</p>

<p>所以我们执行以下语句，创建一个用户 messi，并且只赋予所有数据库上的 SELECT 权限：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">user</span> <span class="s1">'messi'</span><span class="o">@</span><span class="s1">'%'</span> <span class="n">identified</span> <span class="k">by</span> <span class="s1">'pass'</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">grant</span> <span class="k">SELECT</span> <span class="k">on</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">to</span> <span class="s1">'messi'</span><span class="o">@</span><span class="s1">'%'</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div></div>

<p>接着用刚刚创建的账号登录 MySQL，执行如下操作：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">test</span><span class="p">;</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`chelsea`</span> <span class="p">(</span><span class="nv">`id`</span> <span class="n">int</span><span class="p">,</span> <span class="nv">`goal`</span> <span class="n">int</span><span class="p">);</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">chelsea</span> <span class="k">values</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="k">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">chelsea</span><span class="p">;</span>
<span class="o">+</span><span class="c1">------+------+</span>
<span class="o">|</span> <span class="n">id</span>   <span class="o">|</span> <span class="n">goal</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">------+------+</span>
<span class="o">|</span>    <span class="mi">2</span> <span class="o">|</span>    <span class="mi">3</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">------+------+</span>
<span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div></div>

<p>这是怎么一回事呢？ 明明在创建用户的时候只赋予了 SELECT 权限，竟然可以执行 INSERT 操作了。</p>

<h3 id="super-权限">Super 权限</h3>
<p>Super 权限相当于 Linux 的 Root 权限，但是它能够为所欲为吗？</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">performance_schema</span><span class="p">;</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`chelsea`</span> <span class="p">(</span><span class="nv">`id`</span> <span class="n">int</span><span class="p">,</span> <span class="nv">`goal`</span> <span class="n">int</span><span class="p">);</span>
<span class="n">ERROR</span> <span class="mi">1142</span> <span class="p">(</span><span class="mi">42000</span><span class="p">):</span> <span class="k">CREATE</span> <span class="n">command</span> <span class="n">denied</span> <span class="k">to</span> <span class="k">user</span> <span class="s1">'root'</span><span class="o">@</span><span class="s1">'127.0.0.1'</span> <span class="k">for</span> <span class="k">table</span> <span class="s1">'chelsea'</span>
</code></pre></div></div>

<p>我们尝试在 performance_schema 表中创建一张表，可是看到 root 用户被无情的告知权限不足。</p>

<p><strong>以上述两个问题为引，这篇文章简单介绍一下 MySQL 的权限体系。</strong></p>

<h2 id="权限简介">权限简介</h2>
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/privileges-provided.html">官方文档</a>对权限有比较详细的描述，为了方便我把其中的表格列在下面。第一列表示所有的权限，可以在 Grant 语句中指定的，第二列是对应权限存储在系统数据库 mysql 几张表中的定义，第三列表示权限作用的范围，Global（Server administration）对应 mysql.user 表，Database 对应 mysql.db 表，Tables 对应 mysql.tables_priv 表，Columns 对应 mysql.columns_priv 表，Stored routines 对应 mysql.procs_priv 表。</p>

<table>
  <thead>
    <tr>
      <th>Privilege</th>
      <th>Column</th>
      <th>Context</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ALL [PRIVILEGES]</td>
      <td>Synonym for “all privileges”</td>
      <td>Server administration</td>
    </tr>
    <tr>
      <td>ALTER</td>
      <td>Alter_priv</td>
      <td>Tables</td>
    </tr>
    <tr>
      <td>ALTER ROUTINE</td>
      <td>Alter_routine_priv</td>
      <td>Stored routines</td>
    </tr>
    <tr>
      <td>CREATE</td>
      <td>Create_priv</td>
      <td>Databases, tables, or indexes</td>
    </tr>
    <tr>
      <td>CREATE ROUTINE</td>
      <td>Create_routine_priv</td>
      <td>Stored routines</td>
    </tr>
    <tr>
      <td>CREATE TABLESPACE</td>
      <td>Create_tablespace_priv</td>
      <td>Server administration</td>
    </tr>
    <tr>
      <td>CREATE TEMPORARY TABLES</td>
      <td>Create_tmp_table_priv</td>
      <td>Tables</td>
    </tr>
    <tr>
      <td>CREATE USER</td>
      <td>Create_user_priv</td>
      <td>Server administration</td>
    </tr>
    <tr>
      <td>CREATE VIEW</td>
      <td>Create_view_priv</td>
      <td>Views</td>
    </tr>
    <tr>
      <td>DELETE</td>
      <td>Delete_priv</td>
      <td>Tables</td>
    </tr>
    <tr>
      <td>DROP</td>
      <td>Drop_priv</td>
      <td>Databases, tables, or views</td>
    </tr>
    <tr>
      <td>EVENT</td>
      <td>Event_priv</td>
      <td>Databases</td>
    </tr>
    <tr>
      <td>EXECUTE</td>
      <td>Execute_priv</td>
      <td>Stored routines</td>
    </tr>
    <tr>
      <td>FILE</td>
      <td>File_priv</td>
      <td>File access on server host</td>
    </tr>
    <tr>
      <td>GRANT OPTION</td>
      <td>Grant_priv</td>
      <td>Databases, tables, or stored routines</td>
    </tr>
    <tr>
      <td>INDEX</td>
      <td>Index_priv</td>
      <td>Tables</td>
    </tr>
    <tr>
      <td>INSERT</td>
      <td>Insert_priv</td>
      <td>Tables or columns</td>
    </tr>
    <tr>
      <td>LOCK TABLES</td>
      <td>Lock_tables_priv</td>
      <td>Databases</td>
    </tr>
    <tr>
      <td>PROCESS</td>
      <td>Process_priv</td>
      <td>Server administration</td>
    </tr>
    <tr>
      <td>PROXY	See</td>
      <td>proxies_priv</td>
      <td>table	Server administration</td>
    </tr>
    <tr>
      <td>REFERENCES</td>
      <td>References_priv</td>
      <td>Databases or tables</td>
    </tr>
    <tr>
      <td>RELOAD</td>
      <td>Reload_priv</td>
      <td>Server administration</td>
    </tr>
    <tr>
      <td>REPLICATION CLIENT</td>
      <td>Repl_client_priv</td>
      <td>Server administration</td>
    </tr>
    <tr>
      <td>REPLICATION SLAVE</td>
      <td>Repl_slave_priv</td>
      <td>Server administration</td>
    </tr>
    <tr>
      <td>SELECT</td>
      <td>Select_priv</td>
      <td>Tables or columns</td>
    </tr>
    <tr>
      <td>SHOW DATABASES</td>
      <td>Show_db_priv</td>
      <td>Server administration</td>
    </tr>
    <tr>
      <td>SHOW VIEW</td>
      <td>Show_view_priv</td>
      <td>Views</td>
    </tr>
    <tr>
      <td>SHUTDOWN</td>
      <td>Shutdown_priv</td>
      <td>Server administration</td>
    </tr>
    <tr>
      <td>SUPER</td>
      <td>Super_priv</td>
      <td>Server administration</td>
    </tr>
    <tr>
      <td>TRIGGER</td>
      <td>Trigger_priv</td>
      <td>Tables</td>
    </tr>
    <tr>
      <td>UPDATE</td>
      <td>Update_priv</td>
      <td>Tables or columns</td>
    </tr>
    <tr>
      <td>USAGE</td>
      <td>Synonym for “no privileges”</td>
      <td>Server administration</td>
    </tr>
  </tbody>
</table>

<h3 id="权限存储">权限存储</h3>
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/grant.html">GRANT 语句</a> 赋予对应用户相应的权限，会根据不同的语法存储到不同的表中，以链接中官方文档中的语句为例：</p>

<h4 id="global-privileges">Global Privileges</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'someuser'</span><span class="o">@</span><span class="s1">'somehost'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">SELECT</span><span class="p">,</span> <span class="k">INSERT</span> <span class="k">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'someuser'</span><span class="o">@</span><span class="s1">'somehost'</span><span class="p">;</span>
</code></pre></div></div>
<p>其中 *.* 表示所有数据的所有表，对应的权限会保存在 mysql.user 表中，和 user 相关联。</p>

<h4 id="database-privileges">Database Privileges</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">ON</span> <span class="n">mydb</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'someuser'</span><span class="o">@</span><span class="s1">'somehost'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">SELECT</span><span class="p">,</span> <span class="k">INSERT</span> <span class="k">ON</span> <span class="n">mydb</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'someuser'</span><span class="o">@</span><span class="s1">'somehost'</span><span class="p">;</span>
</code></pre></div></div>
<p>其中 mydb.* 表示 mydb Database 下的所有表，对应的权限会保存在 mysql.db 表中，和 db 相关联。</p>

<h4 id="table-privileges">Table Privileges</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">ON</span> <span class="n">mydb</span><span class="p">.</span><span class="n">mytbl</span> <span class="k">TO</span> <span class="s1">'someuser'</span><span class="o">@</span><span class="s1">'somehost'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">SELECT</span><span class="p">,</span> <span class="k">INSERT</span> <span class="k">ON</span> <span class="n">mydb</span><span class="p">.</span><span class="n">mytbl</span> <span class="k">TO</span> <span class="s1">'someuser'</span><span class="o">@</span><span class="s1">'somehost'</span><span class="p">;</span> 
</code></pre></div></div>
<p>对应的权限保存在 mysql.tables_priv 中，和 db , user 关联。</p>

<h4 id="column-privileges">Column Privileges</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">GRANT</span> <span class="k">SELECT</span> <span class="p">(</span><span class="n">col1</span><span class="p">),</span> <span class="k">INSERT</span> <span class="p">(</span><span class="n">col1</span><span class="p">,</span><span class="n">col2</span><span class="p">)</span> <span class="k">ON</span> <span class="n">mydb</span><span class="p">.</span><span class="n">mytbl</span> <span class="k">TO</span> <span class="s1">'someuser'</span><span class="o">@</span><span class="s1">'somehost'</span><span class="p">;</span>
</code></pre></div></div>
<p>对应的权限保存在 mysql.tables_priv 中，和 db, table, user 关联。</p>

<h4 id="stored-routine-privileges">Stored Routine Privileges</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">GRANT</span> <span class="k">CREATE</span> <span class="k">ROUTINE</span> <span class="k">ON</span> <span class="n">mydb</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'someuser'</span><span class="o">@</span><span class="s1">'somehost'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">EXECUTE</span> <span class="k">ON</span> <span class="k">PROCEDURE</span> <span class="n">mydb</span><span class="p">.</span><span class="n">myproc</span> <span class="k">TO</span> <span class="s1">'someuser'</span><span class="o">@</span><span class="s1">'somehost'</span><span class="p">;</span>
</code></pre></div></div>
<p>对应的权限保存在 mysql.procs_priv 中，和 routine_name， db，user 关联。</p>

<h4 id="认证过程">认证过程</h4>
<p>在源码中，每一种 Privilege 都用一个 bit 位表示，具体宏定义在 <a href="https://github.com/alibaba/AliSQL/blob/master/sql/sql_acl.h">sql_acl.h</a> 中，几乎所有的语句操作都需要进行权限验证，根据不同的语句类型，可以获取到需要哪些权限，参考函数 <a href="https://github.com/alibaba/AliSQL/blob/master/sql/sql_parse.cc">mysql_execute_command</a>，获得一个重要的长整型参数 want_access, 表示需要的权限有哪些。</p>

<p>整体认证的思路比较简单，对于权限的判断自然是自上而下的，假如一个用户有对某个数据库的写权限，自然不必继续判断对该数据库下的某个表是否有写权限。 从上述存储的表中可以查到对应的权限，然后和 want_access 进行位操作，判断是否包含了 want_access 需要的全部权限。 考虑一下这种情况，假如一个用户对某个数据库只有SELECT 权限，但是对该数据库其中的一张表只有 INSERT 权限，假如对表请求的 want_access 是 3 （二进制 11 表示 SELECT 和 INSERT 权限），自上而下先先判断数据库的权限，无法满足，接着再判断表的权限，依然无法满足。但是数据库的 SELECT 权限实际上表示对表也有 SELECT 权限，只是没有保存到mysql.tables_priv 表中罢了。所以在自上而下认证的过程中需要把上级已经获得的权限传递给下级。权限的使用频率非常高，如果每次都从数据库中查找效率太低，MySQL 将其缓存起来，在<a href="http://mysql.taobao.org/monthly/2015/10/10/">早期月报</a>中就讨论过权限的缓存，可以参考。</p>

<p>下面从源码角度看一下上述过程是怎么实现的，主要的函数有两个，check_access 判断 Global 和 Database 级别， check_grant 判断 Table 级别，一般会先调用 check_access 再接着调用 check_grant ，对于 Column 级别的需要查表判断对应列是否存在等，暂且不讨论，判断的原理都相似。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">bool</span>
<span class="n">check_access</span><span class="p">(</span><span class="n">THD</span> <span class="o">*</span><span class="n">thd</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">want_access</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span> <span class="n">ulong</span> <span class="o">*</span><span class="n">save_priv</span><span class="p">,</span>
             <span class="n">GRANT_INTERNAL_INFO</span> <span class="o">*</span><span class="n">grant_internal_info</span><span class="p">,</span>
             <span class="kt">bool</span> <span class="n">dont_check_global_grants</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">no_errors</span><span class="p">)</span>
</code></pre></div></div>
<p>其中 save_priv 就是传递给下级的权限，一般会在 check_grant 中使用。在函数开头就初始化为 0.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">((</span><span class="n">db</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">db</span> <span class="o">!=</span> <span class="n">any_db</span><span class="p">))</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="n">ACL_internal_schema_access</span> <span class="o">*</span><span class="n">acces</span>
	<span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>
<p>这部分是对 Performance_schema 和 Informantion_schema 判断的逻辑，下一节会详细介绍。</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">((</span><span class="n">sctx</span><span class="o">-&gt;</span><span class="n">master_access</span> <span class="o">&amp;</span> <span class="n">want_access</span><span class="p">)</span> <span class="o">==</span> <span class="n">want_access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">...</span>
	
	<span class="k">if</span><span class="err">（</span><span class="p">..</span><span class="err">）</span>
		<span class="o">*</span><span class="n">save_priv</span><span class="o">|=</span> <span class="n">sctx</span><span class="o">-&gt;</span><span class="n">master_access</span> <span class="o">|</span> <span class="n">db_access</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">save_priv</span><span class="o">|=</span> <span class="n">sctx</span><span class="o">-&gt;</span><span class="n">master_access</span><span class="p">;</span>
	
	<span class="n">DBUG_RETURN</span><span class="p">(</span><span class="n">FALSE</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>sctx-&gt;master_access 是从 mysql.user 表中获得的 Global 级别的权限，在用户和数据库建立连接就会初始化，上述代码表示全局的级别已经满足了 want_access 申请的权限。由于还要调用 check_grant ， 在末尾把全局权限放到 save_priv 中。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">if</span> <span class="p">(((</span><span class="n">want_access</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">sctx</span><span class="o">-&gt;</span><span class="n">master_access</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DB_ACLS</span><span class="p">)</span> <span class="o">||</span>
      <span class="p">(</span><span class="o">!</span> <span class="n">db</span> <span class="o">&amp;&amp;</span> <span class="n">dont_check_global_grants</span><span class="p">))</span>
<span class="err">{</span>	
	 <span class="p">...</span>
	 
	 <span class="n">DBUG_RETURN</span><span class="p">(</span><span class="k">TRUE</span><span class="p">);</span>		
<span class="err">}</span>
</code></pre></div></div>
<p>DB_ACLS 是一个宏定义，表示 db 级别的所有权限集合，根据判断条件来看，如果申请的权限没有全部在 sctx-&gt;master_access 中满足，并且也不属于 DB_ACLS 的一种，那么认为是无法获得的。或者是传入参数 db 为空，并且参数 dont_check_global_grants 为 true，也返回校验失败。这个逻辑还没有走到过，暂且记下。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">if</span> <span class="p">(</span><span class="n">db</span> <span class="o">==</span> <span class="n">any_db</span><span class="p">)</span>
  <span class="err">{</span>
    <span class="cm">/*
      Access granted; Allow select on *any* db.
      [out] *save_privileges= 0
    */</span>
    <span class="n">DBUG_RETURN</span><span class="p">(</span><span class="k">FALSE</span><span class="p">);</span>
  <span class="err">}</span>
</code></pre></div></div>
<p>这个是处理一些通用的情况，不涉及具体的 db。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">if</span> <span class="p">(</span><span class="n">db</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">thd</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">||</span> <span class="n">db_is_pattern</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">thd</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">)))</span>
    <span class="n">db_access</span><span class="o">=</span> <span class="n">acl_get</span><span class="p">(</span><span class="n">sctx</span><span class="o">-&gt;</span><span class="n">get_host</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">(),</span> <span class="n">sctx</span><span class="o">-&gt;</span><span class="n">get_ip</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">(),</span>
                       <span class="n">sctx</span><span class="o">-&gt;</span><span class="n">priv_user</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">db_is_pattern</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="n">db_access</span><span class="o">=</span> <span class="n">sctx</span><span class="o">-&gt;</span><span class="n">db_access</span><span class="p">;</span>
</code></pre></div></div>
<p>到这里 Global 级别就判断完了，thd-&gt;db 表示当前的数据库是哪一个，也就是执行了 use db 命令之后切换的数据库，切换之后该数据的权限会放到 sctx-&gt;db_access 中，上述判断就是如果 db 不是当前 db，就从缓存里面查找。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">db_access</span><span class="o">=</span> <span class="p">(</span><span class="n">db_access</span> <span class="o">|</span> <span class="n">sctx</span><span class="o">-&gt;</span><span class="n">master_access</span><span class="p">);</span>
  <span class="o">*</span><span class="n">save_priv</span><span class="o">|=</span> <span class="n">db_access</span><span class="p">;</span>
</code></pre></div></div>
<p>传递 db_access 下去。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">db_access</span> <span class="o">&amp;</span> <span class="n">want_access</span><span class="p">)</span> <span class="o">==</span> <span class="n">want_access</span> <span class="o">||</span>
      <span class="p">(</span><span class="o">!</span><span class="n">dont_check_global_grants</span> <span class="o">&amp;&amp;</span>
       <span class="n">need_table_or_column_check</span><span class="p">))</span>
  <span class="err">{</span>
    <span class="n">DBUG_RETURN</span><span class="p">(</span><span class="k">FALSE</span><span class="p">);</span>
  <span class="err">}</span>
  
  <span class="p">...</span>
  
 <span class="n">DBUG_RETURN</span><span class="p">(</span><span class="k">TRUE</span><span class="p">);</span>
</code></pre></div></div>
<p>表示 db_access 已经可以满足 want_access 或者需要 table/column 级别的校验。如果上述校验都没有通过，则返回校验失败。</p>

<p>仔细看完 check_access 函数，check_grant 就相对简单一些, 看下主要逻辑</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">for</span> <span class="p">(</span><span class="n">tl</span><span class="o">=</span> <span class="n">tables</span><span class="p">;</span>
       <span class="n">tl</span> <span class="o">&amp;&amp;</span> <span class="n">number</span><span class="c1">-- &amp;&amp; tl != first_not_own_table;</span>
       <span class="n">tl</span><span class="o">=</span> <span class="n">tl</span><span class="o">-&gt;</span><span class="n">next_global</span><span class="p">)</span>
  <span class="err">{</span>
  		<span class="n">if</span> <span class="p">(</span><span class="k">access</span><span class="p">)</span>
    <span class="err">{</span> 
    	<span class="p">...</span>
    	<span class="o">//</span> <span class="n">Information_schema</span> <span class="o">&amp;&amp;</span> <span class="n">performance_schema</span>
	 <span class="err">}</span>
	 
	 <span class="n">want_access</span><span class="o">=</span> <span class="n">orig_want_access</span><span class="p">;</span>
    <span class="n">want_access</span><span class="o">&amp;=</span> <span class="o">~</span><span class="n">sctx</span><span class="o">-&gt;</span><span class="n">master_access</span><span class="p">;</span>     <span class="o">//</span> <span class="err">判断当前的</span> <span class="k">Global</span> <span class="k">access</span> <span class="err">是否能够满足</span>
    <span class="n">if</span> <span class="p">(</span><span class="o">!</span><span class="n">want_access</span><span class="p">)</span>
      <span class="k">continue</span><span class="p">;</span>       
	 
	 <span class="n">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">~</span><span class="n">t_ref</span><span class="o">-&gt;</span><span class="k">grant</span><span class="p">.</span><span class="n">privilege</span> <span class="o">&amp;</span> <span class="n">want_access</span><span class="p">)</span> <span class="o">||</span>
        <span class="n">t_ref</span><span class="o">-&gt;</span><span class="n">is_anonymous_derived_table</span><span class="p">()</span> <span class="o">||</span> <span class="n">t_ref</span><span class="o">-&gt;</span><span class="n">schema_table</span><span class="p">)</span>
    <span class="err">{</span>
    	<span class="o">//</span> <span class="n">t_ref</span><span class="o">-&gt;</span><span class="k">grant</span><span class="p">.</span><span class="n">privilege</span> <span class="err">实际上就是</span> <span class="n">check_access</span> <span class="err">中的</span> <span class="n">save_priv</span><span class="p">,</span> <span class="err">这里表示继承而来的权限能够满足</span>
    	<span class="o">//</span> <span class="err">其它条件处理继承表和特殊表，暂且不论</span>
    <span class="err">}</span>
	 
	 <span class="n">if</span> <span class="p">(</span><span class="n">is_temporary_table</span><span class="p">(</span><span class="n">t_ref</span><span class="p">))</span>
    <span class="err">{</span>
    	<span class="o">//</span> <span class="err">处理临时表权限</span>
    <span class="err">}</span>
    
    <span class="n">GRANT_TABLE</span> <span class="o">*</span><span class="n">grant_table</span><span class="o">=</span> <span class="n">table_hash_search</span><span class="p">(</span><span class="n">sctx</span><span class="o">-&gt;</span><span class="n">get_host</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">(),</span>
                                                <span class="n">sctx</span><span class="o">-&gt;</span><span class="n">get_ip</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">(),</span>
                                                <span class="n">t_ref</span><span class="o">-&gt;</span><span class="n">get_db_name</span><span class="p">(),</span>
                                                <span class="n">sctx</span><span class="o">-&gt;</span><span class="n">priv_user</span><span class="p">,</span>
                                                <span class="n">t_ref</span><span class="o">-&gt;</span><span class="n">get_table_name</span><span class="p">(),</span>
                                                <span class="k">FALSE</span><span class="p">);</span>
    <span class="o">//</span> <span class="err">查找对应的</span> <span class="k">table</span> <span class="err">的权限，从</span> <span class="n">mysql</span><span class="p">.</span><span class="n">table_priv</span> <span class="err">中</span>
    
    <span class="p">...</span>
    <span class="n">t_ref</span><span class="o">-&gt;</span><span class="k">grant</span><span class="p">.</span><span class="n">privilege</span><span class="o">|=</span> <span class="n">grant_table</span><span class="o">-&gt;</span><span class="n">privs</span><span class="p">;</span> <span class="o">//</span> <span class="err">把刚刚获取的</span> <span class="n">table_privs</span> <span class="err">增加到继承的权限中</span>
    <span class="p">...</span>
    
    <span class="n">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">~</span><span class="n">t_ref</span><span class="o">-&gt;</span><span class="k">grant</span><span class="p">.</span><span class="n">privilege</span> <span class="o">&amp;</span> <span class="n">want_access</span><span class="p">))</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="o">//</span> <span class="err">判断加上</span> <span class="n">table_privs</span> <span class="err">之后是否可以满足条件</span>
    
    <span class="p">...</span>
  <span class="err">}</span>
</code></pre></div></div>

<h4 id="问题分析">问题分析</h4>
<p>再来看一下文章开头说的 test Database 权限问题，我们执行的 grant 语句相当于是给 mysql.user 表增加一条记录，是全局级别的。根据上述判断逻辑，Global 的权限满足不了，就要去 mysql.db 中判断，查一下很容易就可以发现，对于任意的用户都可以在 test Database 上增删改查。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">db</span><span class="err">\</span><span class="k">G</span>
<span class="o">***************************</span> <span class="mi">1</span><span class="p">.</span> <span class="k">row</span> <span class="o">***************************</span>
                 <span class="k">Host</span><span class="p">:</span> <span class="o">%</span>
                   <span class="n">Db</span><span class="p">:</span> <span class="n">test</span>
                 <span class="k">User</span><span class="p">:</span>
          <span class="n">Select_priv</span><span class="p">:</span> <span class="n">Y</span>
          <span class="n">Insert_priv</span><span class="p">:</span> <span class="n">Y</span>
          <span class="n">Update_priv</span><span class="p">:</span> <span class="n">Y</span>
          <span class="n">Delete_priv</span><span class="p">:</span> <span class="n">Y</span>
          <span class="p">...</span>
</code></pre></div></div>
<p>因为 test 是系统初始化的数据库，意图是让更多的用户可以使用，其实这个也可以在 mysql_system_tables_data.sql 中找到一条记录，赋予了 test Database 权限。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Fill "db" table with default grants for anyone to</span>
<span class="c1">-- access database 'test' and 'test_%' if "db" table didn't exist</span>
<span class="k">CREATE</span> <span class="k">TEMPORARY</span> <span class="k">TABLE</span> <span class="n">tmp_db</span> <span class="k">LIKE</span> <span class="n">db</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">tmp_db</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'%'</span><span class="p">,</span><span class="s1">'test'</span><span class="p">,</span><span class="s1">''</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'N'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'N'</span><span class="p">,</span><span class="s1">'N'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">tmp_db</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'%'</span><span class="p">,</span><span class="s1">'test</span><span class="se">\_</span><span class="s1">%'</span><span class="p">,</span><span class="s1">''</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'N'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'N'</span><span class="p">,</span><span class="s1">'N'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">,</span><span class="s1">'Y'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">db</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">tmp_db</span> <span class="k">WHERE</span> <span class="o">@</span><span class="n">had_db_table</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">tmp_db</span><span class="p">;</span>
</code></pre></div></div>

<p>假如我们换一种赋权限的方式：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">grant</span> <span class="k">SELECT</span> <span class="k">on</span> <span class="n">test</span><span class="p">.</span><span class="o">*</span> <span class="k">to</span> <span class="s1">'messi'</span><span class="o">@</span><span class="s1">'%'</span><span class="p">;</span>
</code></pre></div></div>
<p>这样 INSERT 语句就会失败，因为在查找的时候，并不是随意找一个可以匹配的，而是找最匹配的一个，看看是不是有需要的权限。</p>

<h2 id="performance_schema-和-information_schema">Performance_schema 和 Information_schema</h2>
<p>这两个系统表比较特殊，Performance_schema 只有表结构定义文件，没有数据文件，数据来自 mysql 表，而 Information_schema 表连表结构定义都没有，当需要查询的时候在内存中构造。所以对于这两个表的存取权限就是独立的一套机制。同样分为 db 级别和 table 级别，在 check_access 和 check_grant 中调用。</p>

<h3 id="acl_internal_shcema_access">ACL_internal_shcema_access</h3>
<p>ACL_internal_shcema_access 是一个父类，有两个子类分别表示两种数据库，类图如下：
<img src="https://gw.alipayobjects.com/zos/skylark/dc40f31b-7be2-499f-8285-5364481046db/2018/png/bcb78753-a669-4b33-8398-a429271ae612.png" alt="" /></p>

<p>校验的时候首先根据传入的 db 名称获得对应的子类：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">const</span> <span class="n">ACL_internal_schema_access</span> <span class="o">*</span><span class="k">access</span><span class="p">;</span>
<span class="k">access</span><span class="o">=</span> <span class="n">get_cached_schema_access</span><span class="p">(</span><span class="n">grant_internal_info</span><span class="p">,</span> <span class="n">db</span><span class="p">);</span>
</code></pre></div></div>
<p>然后再调用子类的 check 函数完成校验，对于 Information_schema 表，只允许 SELECT 权限，如果申请其它权限并且在 DB_ACL 宏定义中，那么就继续从 table 级别判断，否则的话就拒绝。</p>

<p>对于 Performance_schema 表，函数里表述的也非常清楚，定义了一个变量 always_forbbiden , 如果申请的权限全部包括在其中，就拒绝，否则走 table 级别判断。源码中屏蔽的权限有：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">const</span> <span class="n">ulong</span> <span class="n">always_forbidden</span><span class="o">=</span> <span class="cm">/* CREATE_ACL | */</span> <span class="n">REFERENCES_ACL</span>
    <span class="o">|</span> <span class="n">INDEX_ACL</span> <span class="o">|</span> <span class="n">ALTER_ACL</span> <span class="o">|</span> <span class="n">CREATE_TMP_ACL</span> <span class="o">|</span> <span class="n">EXECUTE_ACL</span>
    <span class="o">|</span> <span class="n">CREATE_VIEW_ACL</span> <span class="o">|</span> <span class="n">SHOW_VIEW_ACL</span> <span class="o">|</span> <span class="n">CREATE_PROC_ACL</span> <span class="o">|</span> <span class="n">ALTER_PROC_ACL</span>
    <span class="o">|</span> <span class="n">EVENT_ACL</span> <span class="o">|</span> <span class="n">TRIGGER_ACL</span> <span class="p">;</span>
</code></pre></div></div>

<h3 id="acl_internal_table_access">ACL_internal_table_access</h3>
<p>同样的，ACL_internal_table_access 也是父类，但是却有众多子类，使用方式和上述 schema_access 有较大区别。校验首先根据 db 名称和 table 名称查找对应的 ACL_internal_table_access 子类，查找过程分为两步：</p>

<ol>
  <li>根据 db 名称找到对应的 ACL_internal_schema_access</li>
  <li>调用 ACL_internal_schema_access 的 look_up 方法查找</li>
</ol>

<p>其中 IS_internal_schema_access 的 look_up 非常简单，直接返回 NULL，表示 information_schema 不支持 table 级别的校验。</p>

<p>相对 PFS_internal_schema_access 复杂一些，首先根据 table name 去查 PFS_engine_table_share，这个类里面有对应 table 的 acl 信息：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="n">ACL_internal_table_access</span> <span class="o">*</span>
<span class="n">PFS_internal_schema_access</span><span class="o">::</span><span class="n">lookup</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="k">const</span>
<span class="p">{</span>
  <span class="k">const</span> <span class="n">PFS_engine_table_share</span><span class="o">*</span> <span class="n">share</span><span class="p">;</span>
  <span class="n">share</span><span class="o">=</span> <span class="n">PFS_engine_table</span><span class="o">::</span><span class="n">find_engine_table_share</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">share</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">share</span><span class="o">-&gt;</span><span class="n">m_acl</span>
  <span class="p">...</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">pfs_unknown_acl</span>
 <span class="p">}</span>
</code></pre></div></div>

<p>而 PFS_engine_table::find_engine_table_share(name) 这个函数是根据 name 从一个静态数组 all_shars 中比较获取, 而 all_share 的初始化是从不同的类中的静态成员变量 m_share 中获取，以表 performance_schema.user 为例，有一个类 table_users :</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/** Table PERFORMANCE_SCHEMA.USERS. */</span>
<span class="k">class</span> <span class="nc">table_users</span> <span class="o">:</span> <span class="k">public</span> <span class="n">cursor_by_user</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="cm">/** Table share */</span>
  <span class="k">static</span> <span class="n">PFS_engine_table_share</span> <span class="n">m_share</span><span class="p">;</span>
  <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>
<p>其实 performance_schema 中的每一张表都对应一个类，它们有共同的父类，继承结构查看<a href="https://dev.mysql.com/doc/dev/mysql-server/latest/classPFS__engine__table.html">这里</a>。而每一个类中都有一个静态变量 m_share，编译时就会初始化，仍然以 table_users 为例：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PFS_engine_table_share</span>
<span class="n">table_users</span><span class="o">::</span><span class="n">m_share</span><span class="o">=</span>
<span class="p">{</span>
  <span class="p">{</span> <span class="n">C_STRING_WITH_LEN</span><span class="p">(</span><span class="s">"users"</span><span class="p">)</span> <span class="p">},</span>
  <span class="o">&amp;</span><span class="n">pfs_truncatable_acl</span><span class="p">,</span>
  <span class="o">&amp;</span><span class="n">table_users</span><span class="o">::</span><span class="n">create</span><span class="p">,</span>
  <span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* write_row */</span>
  <span class="n">table_users</span><span class="o">::</span><span class="n">delete_all_rows</span><span class="p">,</span>
  <span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* get_row_count */</span>
  <span class="mi">1000</span><span class="p">,</span> <span class="cm">/* records */</span>
  <span class="k">sizeof</span><span class="p">(</span><span class="n">PFS_simple_index</span><span class="p">),</span> <span class="cm">/* ref length */</span>
  <span class="o">&amp;</span><span class="n">m_table_lock</span><span class="p">,</span>
  <span class="o">&amp;</span><span class="n">m_field_def</span><span class="p">,</span>
  <span class="nb">false</span> <span class="cm">/* checked */</span>
<span class="p">};</span>
</code></pre></div></div>

<p>其中 pfs_truncatable_acl 就是我们需要的 ACL_internal_table_access 具体的子类，它像 ACL_internal_shcema_access 的校验一样，在 check 函数里定义了 always_forbidden 变量，代表这个类型的权限都被拒绝。这里权限并不是每一个表对应一种，代码中定义几种不同类型的权限，提供给所有的表去使用，看一下类图：
<img src="https://gw.alipayobjects.com/zos/skylark/7cb8f5fa-2444-4216-bfd0-71e20014468a/2018/png/ffe01ab0-5bcf-4268-99ce-b5109284046d.png" alt="" /> 如果想知道具体某个表的权限，代码里查一下就清楚了。所以其实 performance_schema 中 table 的权限都是写死在代码里的（显然 super 用户也无能为力）。</p>

<h3 id="问题分析-1">问题分析</h3>
<p>最后我们看下文章开头提出的问题，super 用户无法在 performance_schema 中创建一个表，其实很明显，一个新创建的表名是在代码中是没有定义的，所以根本找不到对应的 PFS_engine_table_share， 看上面的 look_up 代码，返回的是 pfs_unknown_acl ，而这个类的 always_forbidden 变量屏蔽了 CREATE 权限，自然 Super 用户就没办法了~（PS，可以试验一下 DROP 一个现有的表，重新 CREATE 是没问题的）</p>



                <hr style="visibility: hidden;">

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/computer%20science/mysql/2018/01/24/innodb-lock-system/" data-toggle="tooltip" data-placement="top" title="Innodb 锁子系统浅析">
                        Previous<br>
                        <span>Innodb 锁子系统浅析</span>
                        </a>
                    </li>
                    
                    
                </ul>


                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

                
            </div>  

    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
        				
                            
                				<a href="/tags/#c++" title="c++" rel="6">
                                    c++
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#effective c++" title="effective c++" rel="2">
                                    effective c++
                                </a>
                            
        				
                            
        				
                            
                				<a href="/tags/#Berkeley DB" title="Berkeley DB" rel="6">
                                    Berkeley DB
                                </a>
                            
        				
                            
                				<a href="/tags/#Database" title="Database" rel="7">
                                    Database
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#设计原则" title="设计原则" rel="2">
                                    设计原则
                                </a>
                            
        				
                            
                				<a href="/tags/#面向对象" title="面向对象" rel="4">
                                    面向对象
                                </a>
                            
        				
                            
        				
                            
                				<a href="/tags/#PostgreSQL" title="PostgreSQL" rel="4">
                                    PostgreSQL
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
        			</div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">
                    
                        <li><a href="http://blog.csdn.net/michaelyang_yz">Michael Yang</a></li>
                    
                        <li><a href="http://mysql.taobao.org/monthly/">数据库内核月报</a></li>
                    
                        <li><a href="https://www.percona.com/blog/">percona</a></li>
                    
                        <li><a href="http://dinglin.iteye.com/">丁奇</a></li>
                    
                        <li><a href="http://yoshinorimatsunobu.blogspot.com/">YOSHINORI MATSUNOBU'S BLOG</a></li>
                    
                        <li><a href="https://coolshell.cn/">酷壳</a></li>
                    
                        <li><a href="http://www.pagefault.info/">Pagefault</a></li>
                    
                        <li><a href="http://hedengcheng.com/">何登成</a></li>
                    
                        <li><a href="https://planet.mysql.com/">planet mysql</a></li>
                    
                        <li><a href="http://mysqlserverteam.com/">mysqlserver team</a></li>
                    
                        <li><a href="http://mysqlmusings.blogspot.com/">mysqlmusings</a></li>
                    
                        <li><a href="http://lefred.be/">lefred</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>






<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "zhangxiaojian";
    var disqus_identifier = "/computer%20science/database/2018/02/06/performance schema acl";
    var disqus_url = "http://localhost:4000/computer%20science/database/2018/02/06/performance-schema-acl/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/zhang-xiao-jian-49">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="http://weibo.com/zhangxiaojianjj">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    


                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/zhangxiaojian">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; 张小贱 2018
                    <br>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async('/js/jquery.tagcloud.js',function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-112459552-1';
    var _gaDomain = '';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->



<!-- Side Catalog -->


<!-- Multi-Lingual -->




<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
